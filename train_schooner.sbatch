#!/bin/bash
#SBATCH --partition=largejobs
#SBATCH --exclusive
#SBATCH --mem=31G
#SBATCH --nodes=25
#SBATCH --cpus-per-task=20
#SBATCH --ntasks-per-node=1
#SBATCH --output=%x_%J_stdout.txt
#SBATCH --error=%x_%J_stderr.txt
#SBATCH --time=2-00:00:00
#SBATCH --mail-user=brianhempel@ou.edu
#SBATCH --mail-type=ALL
#SBATCH --chdir=/scratch/brianhempel/

# Usage: SREF_OR_HREF=href FORECAST_HOUR_START=2 FORECAST_HOUR_STOP=13 DATA_SUBSET_RATIO=0.03 NEAR_STORM_RATIO=0.4 EVENT_TYPES=; SREF_OR_HREF=$SREF_OR_HREF FORECAST_HOUR_START=$FORECAST_HOUR_START FORECAST_HOUR_STOP=$FORECAST_HOUR_STOP DATA_SUBSET_RATIO=$DATA_SUBSET_RATIO NEAR_STORM_RATIO=$NEAR_STORM_RATIO EVENT_TYPES=$EVENT_TYPES sbatch --job-name=train_${SREF_OR_HREF}_f${FORECAST_HOUR_START}-${FORECAST_HOUR_STOP}_${DATA_SUBSET_RATIO}_${NEAR_STORM_RATIO}_${EVENT_TYPES} /home/brianhempel/nadocast_dev/train_schooner.sbatch

# SREF_OR_HREF=href FORECAST_HOUR_START=2 FORECAST_HOUR_STOP=13 DATA_SUBSET_RATIO=0.03 NEAR_STORM_RATIO=0.4 EVENT_TYPES=hail,sig_wind_adj; SREF_OR_HREF=$SREF_OR_HREF FORECAST_HOUR_START=$FORECAST_HOUR_START FORECAST_HOUR_STOP=$FORECAST_HOUR_STOP DATA_SUBSET_RATIO=$DATA_SUBSET_RATIO NEAR_STORM_RATIO=$NEAR_STORM_RATIO EVENT_TYPES=$EVENT_TYPES sbatch --job-name=train_${SREF_OR_HREF}_f${FORECAST_HOUR_START}-${FORECAST_HOUR_STOP}_${DATA_SUBSET_RATIO}_${NEAR_STORM_RATIO}_${EVENT_TYPES} /home/brianhempel/nadocast_dev/train_schooner.sbatch
# SREF_OR_HREF=href FORECAST_HOUR_START=2 FORECAST_HOUR_STOP=13 DATA_SUBSET_RATIO=0.03 NEAR_STORM_RATIO=0.4 EVENT_TYPES=sig_tornado,sig_wind; SREF_OR_HREF=$SREF_OR_HREF FORECAST_HOUR_START=$FORECAST_HOUR_START FORECAST_HOUR_STOP=$FORECAST_HOUR_STOP DATA_SUBSET_RATIO=$DATA_SUBSET_RATIO NEAR_STORM_RATIO=$NEAR_STORM_RATIO EVENT_TYPES=$EVENT_TYPES sbatch --job-name=train_${SREF_OR_HREF}_f${FORECAST_HOUR_START}-${FORECAST_HOUR_STOP}_${DATA_SUBSET_RATIO}_${NEAR_STORM_RATIO}_${EVENT_TYPES} /home/brianhempel/nadocast_dev/train_schooner.sbatch
# SREF_OR_HREF=href FORECAST_HOUR_START=2 FORECAST_HOUR_STOP=13 DATA_SUBSET_RATIO=0.03 NEAR_STORM_RATIO=0.4 EVENT_TYPES=tornado,wind; SREF_OR_HREF=$SREF_OR_HREF FORECAST_HOUR_START=$FORECAST_HOUR_START FORECAST_HOUR_STOP=$FORECAST_HOUR_STOP DATA_SUBSET_RATIO=$DATA_SUBSET_RATIO NEAR_STORM_RATIO=$NEAR_STORM_RATIO EVENT_TYPES=$EVENT_TYPES sbatch --job-name=train_${SREF_OR_HREF}_f${FORECAST_HOUR_START}-${FORECAST_HOUR_STOP}_${DATA_SUBSET_RATIO}_${NEAR_STORM_RATIO}_${EVENT_TYPES} /home/brianhempel/nadocast_dev/train_schooner.sbatch

# SREF_OR_HREF=href FORECAST_HOUR_START=13 FORECAST_HOUR_STOP=24 DATA_SUBSET_RATIO=0.03 NEAR_STORM_RATIO=0.4 EVENT_TYPES=wind_adj,sig_hail; SREF_OR_HREF=$SREF_OR_HREF FORECAST_HOUR_START=$FORECAST_HOUR_START FORECAST_HOUR_STOP=$FORECAST_HOUR_STOP DATA_SUBSET_RATIO=$DATA_SUBSET_RATIO NEAR_STORM_RATIO=$NEAR_STORM_RATIO EVENT_TYPES=$EVENT_TYPES sbatch --job-name=train_${SREF_OR_HREF}_f${FORECAST_HOUR_START}-${FORECAST_HOUR_STOP}_${DATA_SUBSET_RATIO}_${NEAR_STORM_RATIO}_${EVENT_TYPES} /home/brianhempel/nadocast_dev/train_schooner.sbatch
# SREF_OR_HREF=href FORECAST_HOUR_START=13 FORECAST_HOUR_STOP=24 DATA_SUBSET_RATIO=0.03 NEAR_STORM_RATIO=0.4 EVENT_TYPES=hail,sig_wind_adj; SREF_OR_HREF=$SREF_OR_HREF FORECAST_HOUR_START=$FORECAST_HOUR_START FORECAST_HOUR_STOP=$FORECAST_HOUR_STOP DATA_SUBSET_RATIO=$DATA_SUBSET_RATIO NEAR_STORM_RATIO=$NEAR_STORM_RATIO EVENT_TYPES=$EVENT_TYPES sbatch --job-name=train_${SREF_OR_HREF}_f${FORECAST_HOUR_START}-${FORECAST_HOUR_STOP}_${DATA_SUBSET_RATIO}_${NEAR_STORM_RATIO}_${EVENT_TYPES} /home/brianhempel/nadocast_dev/train_schooner.sbatch

export HOME=/home/brianhempel
export PATH=$PATH:$HOME/.local/bin:$HOME/bin

module load zlib
module load PROJ
module load OpenMPI

export FORECAST_HOUR_RANGE=${FORECAST_HOUR_START}:${FORECAST_HOUR_STOP}
export JULIA_MPI_BINARY=system
export JULIA_NUM_THREADS=$SLURM_CPUS_PER_TASK
export MUST_LOAD_FROM_DISK=true
export DISTRIBUTED=true

pwd

env

cat /proc/cpuinfo

time mpirun --bind-to none julia --compiled-modules=no --project=/home/brianhempel/nadocast_dev /home/brianhempel/nadocast_dev/models/${SREF_OR_HREF}_mid_2018_forward/TrainGradientBoostedDecisionTrees.jl
